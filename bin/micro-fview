#!/usr/bin/env python

import sys
import time
import logging

import cv2

from microfview import Microfview, BlockingPlugin, PluginFinished, get_capture_object

class DisplayPlugin(BlockingPlugin):

    def process_frame(self, frame_time, current_time, frame):
        cv2.imshow('micro-fview', frame)
        ch = 0xFF & cv2.waitKey(1)
        if ch == 27:
            cv2.destroyWindow('micro-fview')
            raise PluginFinished()

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)

    try:
        fn = sys.argv[1]
    except IndexError:
        fn = ''

    cam = get_capture_object(fn)
    fview = Microfview(cam)
    fview.attach_plugin(DisplayPlugin())

    try:
        fview.start()
        while not fview.finished:
           time.sleep(0.1)
    except KeyboardInterrupt:
        pass
    finally:
        fview.stop()
